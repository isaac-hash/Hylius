# =============================================================================
# Anvil Dashboard API Tests
# =============================================================================
# Usage: Open in VS Code with the "REST Client" extension (humao.rest-client)
#        or any tool that supports .http files (e.g. JetBrains HTTP Client).
#
# WORKFLOW:
#   1. Run "Register" to create an account → copy the token from the response.
#   2. Set @token below (or run "Login" if you already have an account).
#   3. Run the remaining requests in order.
# =============================================================================

@baseUrl = http://localhost:3000
@token   = 16bc249d702728c53dbe5f79b7bf4219d51a3e6846fd07e8be143768f65a8c02


# ─────────────────────────────────────────────────────────────────────────────
# AUTH
# ─────────────────────────────────────────────────────────────────────────────

### Register – create a new organisation + owner account
# Expected: 201 Created  { token, expiresAt, user, organization }
POST {{baseUrl}}/api/auth/register
Content-Type: application/json

{
  "email": "new@email.com",
  "password": "supersecret123",
  "orgName": "New Corp"
}

###

### Register – missing required field (orgName)
# Expected: 400 Bad Request  { error: "Missing required fields: email, password, orgName" }
POST {{baseUrl}}/api/auth/register
Content-Type: application/json

{
  "email": "bad@example.com",
  "password": "supersecret123"
}

###

### Register – duplicate email
# Expected: 409 Conflict  { error: "Email already registered" }
POST {{baseUrl}}/api/auth/register
Content-Type: application/json

{
  "email": "admin@example.com",
  "password": "supersecret123",
  "orgName": "Acme Corp"
}

###

### Login – valid credentials
# Expected: 200 OK  { token, expiresAt, user, organization }
POST {{baseUrl}}/api/auth/login
Content-Type: application/json

{
  "email": "new@email.com",
  "password": "supersecret123"
}

###

### Login – wrong password
# Expected: 401 Unauthorized  { error: "Invalid email or password" }
POST {{baseUrl}}/api/auth/login
Content-Type: application/json

{
  "email": "admin@example.com",
  "password": "wrongpassword"
}

###

### Login – missing fields
# Expected: 400 Bad Request  { error: "Missing required fields: email, password" }
POST {{baseUrl}}/api/auth/login
Content-Type: application/json

{
  "email": "admin@example.com"
}

###

### Me – get current user (requires valid token)
# Expected: 200 OK  { user, organization }
GET {{baseUrl}}/api/auth/me
Authorization: Bearer {{token}}

###

### Me – no token
# Expected: 401 Unauthorized  { error: "Unauthorized" }
GET {{baseUrl}}/api/auth/me

###


# ─────────────────────────────────────────────────────────────────────────────
# SERVERS
# ─────────────────────────────────────────────────────────────────────────────

### List servers (scoped to your organisation)
# Expected: 200 OK  [ ...servers with projects[] ]
GET {{baseUrl}}/api/servers
Authorization: Bearer {{token}}

###

### Create server – with SSH private key (key is encrypted at rest)
# Expected: 200 OK  { id, name, ip, username, port, osType, organizationId, createdAt, updatedAt, projects }
#           NOTE: privateKeyEncrypted / keyIv are intentionally stripped from the response.
POST {{baseUrl}}/api/servers
Content-Type: application/json
Authorization: Bearer {{token}}

{
  "name": "Production VPS",
  "ip": "192.168.1.100",
  "username": "deploy",
  "port": 22,
  "osType": "ubuntu",
  "privateKey": "-----BEGIN OPENSSH PRIVATE KEY-----\nYOUR_PRIVATE_KEY_HERE\n-----END OPENSSH PRIVATE KEY-----"
}

###

### Create server – minimal (no SSH key)
# Expected: 200 OK  { id, name, ip, username, port, ... }
POST {{baseUrl}}/api/servers
Content-Type: application/json
Authorization: Bearer {{token}}

{
  "name": "Staging VPS",
  "ip": "10.0.0.50",
  "username": "ubuntu"
}

###

### Create server – missing required fields
# Expected: 400 Bad Request  { error: "Missing required fields" }
POST {{baseUrl}}/api/servers
Content-Type: application/json
Authorization: Bearer {{token}}

{
  "name": "Incomplete Server"
}

###

### Create server – no auth token
# Expected: 401 Unauthorized  { error: "Unauthorized" }
POST {{baseUrl}}/api/servers
Content-Type: application/json

{
  "name": "Ghost Server",
  "ip": "1.2.3.4",
  "username": "root"
}

###


# ─────────────────────────────────────────────────────────────────────────────
# PROJECTS
# ─────────────────────────────────────────────────────────────────────────────
# NOTE: Replace SERVER_ID below with a real server id from the "List servers"
#       or "Create server" response above.

@serverId = cmlwgt9rr000fjwxxgollk9n7

### List projects (scoped to your organisation)
# Expected: 200 OK  [ ...projects with server{id,name,ip} and _count{deployments} ]
GET {{baseUrl}}/api/projects
Authorization: Bearer {{token}}

###

### Create project – full payload
# Expected: 200 OK  { id, name, repoUrl, branch, deployPath, buildCommand, startCommand, serverId, organizationId, server, ... }
POST {{baseUrl}}/api/projects
Content-Type: application/json
Authorization: Bearer {{token}}

{
  "name": "My Web App",
  "repoUrl": "https://github.com/example/my-web-app.git",
  "branch": "main",
  "deployPath": "/var/www/my-web-app",
  "buildCommand": "npm run build",
  "startCommand": "npm start",
  "serverId": "{{serverId}}"
}

###

### Create project – minimal (branch defaults to "main")
# Expected: 200 OK
POST {{baseUrl}}/api/projects
Content-Type: application/json
Authorization: Bearer {{token}}

{
  "name": "Simple App",
  "repoUrl": "https://github.com/example/simple-app.git",
  "deployPath": "/var/www/simple-app",
  "serverId": "{{serverId}}"
}

###

### Create project – missing required fields
# Expected: 400 Bad Request  { error: "Missing required fields: name, repoUrl, deployPath, serverId" }
POST {{baseUrl}}/api/projects
Content-Type: application/json
Authorization: Bearer {{token}}

{
  "name": "Incomplete Project"
}

###

### Create project – server not in your org
# Expected: 404 Not Found  { error: "Server not found or does not belong to your organization" }
POST {{baseUrl}}/api/projects
Content-Type: application/json
Authorization: Bearer {{token}}

{
  "name": "Bad Project",
  "repoUrl": "https://github.com/example/bad.git",
  "deployPath": "/var/www/bad",
  "serverId": "00000000-0000-0000-0000-000000000000"
}

###

### Create project – no auth token
# Expected: 401 Unauthorized  { error: "Unauthorized" }
POST {{baseUrl}}/api/projects
Content-Type: application/json

{
  "name": "Ghost Project",
  "repoUrl": "https://github.com/example/ghost.git",
  "deployPath": "/var/www/ghost",
  "serverId": "{{serverId}}"
}

###


# ─────────────────────────────────────────────────────────────────────────────
# DEPLOYMENTS
# ─────────────────────────────────────────────────────────────────────────────
# NOTE: Replace PROJECT_ID below with a real project id from the responses above.

@projectId = cmlwgv88c000hjwxxi0g22wg6

### List all deployments (last 50, scoped to your org)
# Expected: 200 OK  [ ...deployments with project{name} ]
GET {{baseUrl}}/api/deployments
Authorization: Bearer {{token}}

###

### List deployments filtered by project
# Expected: 200 OK  [ ...deployments for the given projectId ]
GET {{baseUrl}}/api/deployments?projectId={{projectId}}
Authorization: Bearer {{token}}

###

### List deployments – no auth token
# Expected: 401 Unauthorized  { error: "Unauthorized" }
GET {{baseUrl}}/api/deployments

###
